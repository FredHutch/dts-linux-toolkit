#!/bin/bash
#
# Creates Active Dirctory computer object with host service principle, aka "joins AD Domain"
#

OU='ou=Workstations,ou=Computers,ou=SciComp'

if [ $# -ne 1 ]
then
  hostfqdn=`hostname -f`
else
  hostfqdn=$1
fi

computername=`hostname -s`

if [ "$hostfqdn" = "$computername" ]
then
  hostfqdn="${computername}.fhcrc.org"
fi

# add --verbose for debugging
# host principal is needed for sso via sshd but can also be provided via samba/winbind

msktutil --dont-expire-password --no-pac --computer-name $computername --server dc --enctypes 0x07 -b "$OU" -k /etc/krb5.keytab -h $hostfqdn -s host/$hostfqdn -s HOST/$computername --upn host/$hostfqdn  --description "Kerberos Account by msktutil"

klist -k -t -e

exit 0
